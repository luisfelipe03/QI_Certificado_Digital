<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificados Lucro Presumido</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <button id="btn-home">Voltar</button>
    </header>

    <h1>Certificados Lucro Presumido</h1>

    <ul id="certificados-list">
        <!-- Certificados serão carregados aqui dinamicamente -->
    </ul>
    
    <h2>Adicionar Novo Certificado</h2>
    <form id="form-upload" enctype="multipart/form-data">
        <label for="arquivoPfx">Arquivo PFX:</label>
        <input type="file" id="arquivoPfx" name="arquivoPfx" required style="margin-bottom: 10px; display: block; width: calc(100% - 20px);">
        <label for="senha">Senha:</label>
        <input type="password" id="senha" name="senha" required style="margin-bottom: 10px; display: block; width: calc(100% - 20px);">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: calc(100% - 20px);">Enviar</button>
    </form>

    <div id="mensagem"></div>

    <script>
        const baseUrl = "http://localhost:8080/api/certificado-pj/LP";
        const uploadUrl = "http://localhost:8080/api/certificado-pj/upload";

        $(document).ready(function() {
            // Estilizando a página
            $("body").css("font-family", "Arial, sans-serif");
            $("header").css({
                "background-color": "#f0f0f0",
                "padding": "10px",
                "text-align": "center"
            });
            $("header button").css({
                "background-color": "transparent",
                "color": "#555",
                "border": "none",
                "padding": "5px 10px",
                "font-size": "14px",
                "cursor": "pointer"
            });
            $("h1").css({
                "text-align": "center",
                "color": "#333"
            });
            $("h2").css({
                "margin-top": "20px"
            });
            $("form").css({
                "margin-bottom": "20px"
            });
            $("input[type=file], input[type=password], button[type=submit]").css({
                "box-sizing": "border-box"
            });
            $("button[type=submit]").css({
                "background-color": "#4CAF50",
                "color": "white",
                "padding": "10px 20px",
                "border": "none",
                "border-radius": "4px",
                "cursor": "pointer"
            });
            $("button[type=submit]:hover").css({
                "background-color": "#45a049"
            });

            // Carregar certificados ao carregar a página
            carregarCertificados();

            // Enviar formulário ao adicionar novo certificado
            $("#form-upload").submit(function(event) {
                event.preventDefault();
                adicionarCertificado();
            });
            $("#btn-home").click(function() {
                window.location.href = "./home.html";
            });
        });

        // Função para carregar os certificados
        function carregarCertificados() {
            fetch(baseUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erro ao carregar certificados: " + response.statusText);
                }
                return response.json();
            })
            .then(certificados => {
                var certificadosList = $("#certificados-list");
                certificadosList.empty();
                certificados.forEach(certificado => {
                    var li = $("<li>").text(`Razão Social: ${certificado.razaoSocial}, CNPJ: ${certificado.cnpj}, Data de Emissão: ${certificado.dataEmisao}, Data de Vencimento: ${certificado.dataVencimento}`);
                    
                    var btnExcluir = $("<button>").text("Excluir").click(function() {
                        excluirCertificado(certificado.uuid);
                    });
                    
                    li.append(btnExcluir);
                    certificadosList.append(li);
                });
            })
            .catch(error => {
                console.error("Erro:", error);
            });
        }


        // Função para adicionar um novo certificado
        function adicionarCertificado() {
            var formData = new FormData($("#form-upload")[0]);
            // Adicionando manualmente o campo "tipoCertificado" ao formData
            formData.append("tipoCertificado", "LP");
            $.ajax({
                url: uploadUrl,
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $("#mensagem").text("Certificado adicionado com sucesso").removeClass("error").addClass("success");
                    carregarCertificados();
                    $("#form-upload")[0].reset();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#mensagem").text("Erro ao adicionar certificado: " + jqXHR.responseText).removeClass("success").addClass("error");
                }
            });
        }


        // Função para excluir um certificado
        function excluirCertificado(uuid) {
            $.ajax({
                url: baseUrl + "/" + uuid,
                type: "DELETE",
                success: function(response) {
                    $("#mensagem").text("Certificado excluído com sucesso").removeClass("error").addClass("success");
                    carregarCertificados();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#mensagem").text("Erro ao excluir certificado: " + jqXHR.responseText).removeClass("success").addClass("error");
                }
            });
        }
    </script>

    <style>
        .success {
            color: green;
        }

        .error {
            color: red;
        }

        #certificados-list {
            list-style: none;
            padding: 0;
        }

        #certificados-list li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        #certificados-list li button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }

        #certificados-list li button:hover {
            background-color: #d32f2f;
        }
    </style>
</body>
</html>
